<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TÃ¬m Äiá»ƒm Du Lá»‹ch Viá»‡t Nam</title>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—ºï¸</text></svg>">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
    }
    
    /* Ensure emojis and Vietnamese characters render properly */
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    h1, h2 {
      font-weight: 700;
      letter-spacing: -0.025em;
    }
    
    #map {
      height: 600px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.8);
    }
    
    .poi-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .poi-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 24px -4px rgba(0, 0, 0, 0.2);
      border-color: #3b82f6;
    }
    
    .quick-search {
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    
    .quick-search:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
      border-color: #3b82f6;
    }
    
    .quick-search:active {
      transform: scale(0.95);
    }
    
    .loading-spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .marker-icon {
      background-color: #3b82f6;
      border: 3px solid white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .search-input-wrapper {
      position: relative;
    }
    
    .search-input-wrapper::before {
      content: 'ğŸ”';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      pointer-events: none;
      z-index: 10;
    }
    
    #locationInput {
      padding-left: 48px !important;
    }
    
    .feature-badge {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    /* Login Screen Overlay */
    #loginScreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    
    #loginScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    #appContent.blurred {
      filter: blur(10px);
      pointer-events: none;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
  <!-- Login Screen Overlay -->
  <div id="loginScreen">
    <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full mx-4 text-center">
      <div class="text-6xl mb-6">ğŸ—ºï¸</div>
      <h1 class="text-3xl font-bold text-gray-900 mb-3">KhÃ¡m PhÃ¡ Viá»‡t Nam</h1>
      <p class="text-gray-600 mb-8">ÄÄƒng nháº­p Ä‘á»ƒ khÃ¡m phÃ¡ cÃ¡c Ä‘iá»ƒm du lá»‹ch tuyá»‡t vá»i vÃ  lÆ°u Ä‘á»‹a Ä‘iá»ƒm yÃªu thÃ­ch cá»§a báº¡n</p>
      
      <button id="btnLoginScreen" class="w-full px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-xl hover:from-blue-700 hover:to-purple-700 active:scale-95 transition-all shadow-lg text-lg flex items-center justify-center gap-3">
        <span>ğŸ”</span>
        <span>ÄÄƒng nháº­p vá»›i Google</span>
      </button>
      
      <div class="mt-8 space-y-2">
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <span class="text-2xl">âœ…</span>
          <span>LÆ°u Ä‘á»‹a Ä‘iá»ƒm yÃªu thÃ­ch</span>
        </div>
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <span class="text-2xl">ğŸ—ºï¸</span>
          <span>KhÃ¡m phÃ¡ 5 Ä‘iá»ƒm thÃº vá»‹</span>
        </div>
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <span class="text-2xl">ğŸŒ¤ï¸</span>
          <span>Xem thá»i tiáº¿t Ä‘á»‹a phÆ°Æ¡ng</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main App Content (hidden until login) -->
  <div id="appContent" class="container mx-auto px-4 py-8 blurred">
    

    <!-- Header with Auth -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-100">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="text-3xl font-bold mb-2">
            <span class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-2xl shadow-lg">
              ğŸ—ºï¸ KhÃ¡m PhÃ¡ Viá»‡t Nam
            </span>
          </h1>
          <div class="flex gap-2 flex-wrap mt-2">
            <span class="feature-badge">ğŸ¯ TÃ¬m kiáº¿m nhanh</span>
            <span class="feature-badge">ğŸ“ 5 Ä‘iá»ƒm thÃº vá»‹</span>
            <span class="feature-badge">ğŸ—¨ï¸ Miá»…n phÃ­ 100%</span>
          </div>
        </div>
        
        <!-- Auth Area -->
        <div id="authArea" class="flex items-center gap-3">
          <button id="btnSignIn" class="hidden px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold shadow-lg hover:from-blue-700 hover:to-blue-800 active:scale-95 transition-all">
            ğŸ” ÄÄƒng nháº­p Google
          </button>
          <div id="userChip" class="hidden items-center gap-3 px-4 py-2 rounded-full bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 shadow">
            <img id="avatar" class="h-10 w-10 rounded-full border-2 border-white shadow" alt="avatar">
            <div class="flex flex-col">
              <span id="displayName" class="text-sm font-bold text-gray-800"></span>
              <span class="text-xs text-gray-500">ÄÃ£ Ä‘Äƒng nháº­p</span>
            </div>
            <button id="btnSignOut" class="ml-2 px-3 py-1.5 rounded-lg bg-white hover:bg-red-50 text-red-600 text-sm font-semibold border border-red-200 hover:border-red-300 transition-all">
              ThoÃ¡t
            </button>
          </div>
        </div>
      </div>
      
      <!-- User Status Hint -->
      <div id="authHint" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 text-center">
        ğŸ’¡ <strong>ÄÄƒng nháº­p</strong> Ä‘á»ƒ lÆ°u cÃ¡c Ä‘á»‹a Ä‘iá»ƒm yÃªu thÃ­ch cá»§a báº¡n!
      </div>
    </div>

    <!-- Quick Translator removed - using main translator below -->

    <!-- Search Section -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100">
      <div class="flex gap-4 flex-col sm:flex-row">
        <div class="flex-1">
          <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
            <span>ğŸ“Œ</span>
            <span>Nháº­p tÃªn Ä‘á»‹a Ä‘iá»ƒm á»Ÿ Viá»‡t Nam:</span>
          </label>
          <div class="search-input-wrapper">
            <input 
              type="text" 
              id="locationInput" 
              placeholder="VÃ­ dá»¥: HÃ  Ná»™i, ÄÃ  Náºµng, Há»™i An, Nha Trang..."
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all text-lg"
              autocomplete="off"
            />
          </div>
        </div>
        <div class="flex items-end">
          <button 
            id="searchBtn" 
            class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-xl hover:from-blue-700 hover:to-blue-800 active:scale-95 transition-all shadow-lg hover:shadow-xl"
          >
            ğŸ” TÃ¬m kiáº¿m
          </button>
        </div>
      </div>
      
      <!-- Loading indicator -->
      <div id="loading" class="hidden mt-6 flex items-center justify-center p-6 bg-blue-50 rounded-xl">
        <div class="loading-spinner"></div>
        <span class="ml-4 text-blue-700 font-semibold text-lg">Äang tÃ¬m kiáº¿m Ä‘iá»ƒm thÃº vá»‹...</span>
      </div>
      
      <!-- Error message -->
      <div id="errorMsg" class="hidden mt-6 p-5 bg-red-50 border-2 border-red-300 text-red-800 rounded-xl font-medium"></div>
      
      <!-- Quick search buttons -->
      <div class="mt-6">
        <p class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
          <span>âš¡</span>
          <span>Hoáº·c chá»n Ä‘á»‹a Ä‘iá»ƒm phá»• biáº¿n:</span>
        </p>
        <div class="flex flex-wrap gap-3">
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="HÃ  Ná»™i">
            ğŸ“ HÃ  Ná»™i
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="Há»™i An">
            ğŸ® Há»™i An
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="ÄÃ  Náºµng">
            ğŸŒŠ ÄÃ  Náºµng
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="Nha Trang">
            ğŸ–ï¸ Nha Trang
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="SÃ i GÃ²n">
            ğŸ™ï¸ SÃ i GÃ²n
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="PhÃº Quá»‘c">
            ğŸï¸ PhÃº Quá»‘c
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="Huáº¿">
            ğŸ‘‘ Huáº¿
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="ÄÃ  Láº¡t">
            ğŸŒ¹ ÄÃ  Láº¡t
          </button>
          <button class="quick-search px-5 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-blue-50 hover:to-blue-100 rounded-full text-sm font-semibold shadow-sm" data-location="SÃ³c TrÄƒng">
            ğŸŒ¾ SÃ³c TrÄƒng
          </button>
        </div>
      </div>
    </div>

      <!-- Translation Bar (English â†’ Vietnamese) -->
      <div id="translateSection" class="mt-6 bg-white rounded-2xl p-6 border border-gray-100">
        <h3 class="text-lg font-semibold mb-3">ğŸ”¤ Dá»‹ch nhanh (English â†’ Tiáº¿ng Viá»‡t)</h3>
        <div class="flex gap-3 flex-col sm:flex-row">
          <textarea id="translateInput" rows="2" placeholder="Paste or type English text here..." class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 resize-none"></textarea>
          <div class="flex-shrink-0 flex flex-col items-stretch gap-3">
            <button id="translateBtn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold shadow hover:from-green-600 active:scale-95">Dá»‹ch</button>
            <button id="clearTranslateBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl">XoÃ¡</button>
          </div>
        </div>
        <div id="translateResult" class="mt-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500 mb-2">Káº¿t quáº£ (Tiáº¿ng Viá»‡t):</div>
          <div id="translatedText" class="text-gray-900 font-medium"></div>
          <div class="mt-3 flex gap-2">
            <button id="copyTranslateBtn" class="px-3 py-2 bg-blue-600 text-white rounded-md text-sm">Sao chÃ©p</button>
            <button id="openInNewBtn" class="px-3 py-2 bg-white border text-sm rounded-md">Má»Ÿ trong tab má»›i</button>
          </div>
        </div>
      </div>

      <!-- Weather Section -->
    <div id="weatherSection" class="hidden">
      <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-xl p-8 mb-6 border-2 border-blue-200">
        <h2 class="text-3xl font-bold text-gray-800 mb-5 flex items-center gap-3">
          <span class="text-4xl">ğŸŒ¤ï¸</span>
          <span>Weather Information</span>
        </h2>
        <div id="weatherContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
      </div>
    </div>

    <!-- Points of Interest Section (moved before map) -->
    <div id="poiSection" class="hidden">
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <span class="text-4xl">ğŸ“</span>
          <span>5 Äiá»ƒm ThÃº Vá»‹ Gáº§n ÄÃ³</span>
        </h2>
        <div id="poiList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </div>
    </div>
    
    <!-- Saved Favorites Section -->
    <div id="favoritesSection" class="hidden">
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <span class="text-4xl">â­</span>
          <span>Äá»‹a Ä‘iá»ƒm yÃªu thÃ­ch cá»§a báº¡n</span>
        </h2>
        <div id="favoritesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
        <div id="noFavorites" class="text-center py-8 text-gray-500">
          <p class="text-lg">ğŸ“Œ Báº¡n chÆ°a lÆ°u Ä‘á»‹a Ä‘iá»ƒm nÃ o.</p>
          <p class="text-sm mt-2">Nháº¥n nÃºt "ğŸ’¾ LÆ°u" trÃªn cÃ¡c Ä‘á»‹a Ä‘iá»ƒm bÃªn dÆ°á»›i Ä‘á»ƒ lÆ°u yÃªu thÃ­ch!</p>
        </div>
      </div>
    </div>

    <!-- Map Section -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border border-gray-100">
      <h2 class="text-3xl font-bold text-gray-800 mb-5 flex items-center gap-3">
        <span class="text-4xl">ğŸ—ºï¸</span>
        <span>Báº£n Ä‘á»“</span>
      </h2>
      <div id="map"></div>
      <p class="text-xs text-gray-500 mt-3 text-center">
        ğŸ’¡ <strong>Máº¹o:</strong> Click vÃ o marker trÃªn báº£n Ä‘á»“ hoáº·c tháº» bÃªn trÃªn Ä‘á»ƒ xem chi tiáº¿t
      </p>
    </div>
    
    <!-- Debug Info (toggle with Ctrl+Shift+D) -->
    <div id="debugPanel" class="hidden fixed bottom-4 right-4 bg-gray-900 text-white p-4 rounded-lg shadow-2xl max-w-md text-xs font-mono">
      <div class="flex justify-between items-center mb-2">
        <span class="font-bold">ğŸ” Debug Info</span>
        <button onclick="document.getElementById('debugPanel').classList.add('hidden')" class="text-gray-400 hover:text-white">âœ•</button>
      </div>
      <div id="debugContent"></div>
    </div>
  </div>

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // Initialize map centered on Vietnam
    let map = L.map('map').setView([16.0544, 108.2022], 6);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    let markers = [];
    let currentLocation = null;
    let searchCache = new Map(); // Cache for search results
    
    // OpenWeatherMap API key (free tier)
    const WEATHER_API_KEY = '4d8fb5b93d4af21d66a2948710284366'; // Demo KEY
    
    // Detect environment and set API URLs
    const isCodespaces = window.location.hostname.includes('app.github.dev');
    const BACKEND_HOST = isCodespaces 
      ? window.location.hostname.replace('-8001', '-8000')
      : 'localhost:8000';
    const FLASK_HOST = isCodespaces 
      ? window.location.hostname.replace('-8001', '-5001')
      : 'localhost:5001';
    const BACKEND_PROTOCOL = isCodespaces ? 'https:' : 'http:';
    const API_BASE = `${BACKEND_PROTOCOL}//${BACKEND_HOST}`;
    const FLASK_BASE = `${BACKEND_PROTOCOL}//${FLASK_HOST}`;
    
    console.log('ğŸŒ Environment detected:', isCodespaces ? 'GitHub Codespaces' : 'Local');
    console.log('ğŸ”§ API Base:', API_BASE);
    console.log('ğŸ”§ Flask Base:', FLASK_BASE);
    
    // Test backend connectivity on load
    (async () => {
      try {
        const flaskTest = await fetch(FLASK_BASE + '/').catch(e => ({ error: e.message }));
        console.log('ğŸ§ª Flask connectivity:', flaskTest.error ? 'âŒ ' + flaskTest.error : 'âœ… Connected');
      } catch (e) {
        console.error('ğŸ§ª Flask test failed:', e.message);
      }
      try {
        const fastapiTest = await fetch(API_BASE + '/').catch(e => ({ error: e.message }));
        console.log('ğŸ§ª FastAPI connectivity:', fastapiTest.error ? 'âŒ ' + fastapiTest.error : 'âœ… Connected');
      } catch (e) {
        console.error('ğŸ§ª FastAPI test failed:', e.message);
      }
    })();
    
    // Get DOM elements
    const searchBtn = document.getElementById('searchBtn');
    const locationInput = document.getElementById('locationInput');
    const loading = document.getElementById('loading');
    const errorMsg = document.getElementById('errorMsg');
    const poiSection = document.getElementById('poiSection');
    const poiList = document.getElementById('poiList');
    const weatherSection = document.getElementById('weatherSection');
    const weatherContent = document.getElementById('weatherContent');
    
    // Activity Logging Helper
    function logActivity(action, details = {}) {
      const timestamp = new Date().toISOString();
      console.log(`%c[${timestamp}] ğŸ‘¤ USER ACTIVITY`, 'color: #2563eb; font-weight: bold');
      console.log(`Action: ${action}`);
      if (Object.keys(details).length > 0) {
        console.log('Details:', details);
      }
      console.log('---');
    }
    
    // Search function
    async function searchLocation() {
      const query = locationInput.value.trim();
      
      logActivity('SEARCH_LOCATION', { query });
      
      if (!query) {
        showError('Vui lÃ²ng nháº­p tÃªn Ä‘á»‹a Ä‘iá»ƒm!');
        return;
      }
      
        // Clear previous results
        clearMarkers();
        hideError();
        poiSection.classList.add('hidden');
        weatherSection.classList.add('hidden');
        loading.classList.remove('hidden');      try {
        // Check cache first
        const cacheKey = query.toLowerCase();
        if (searchCache.has(cacheKey)) {
          console.log('Using cached results for:', query);
          const cached = searchCache.get(cacheKey);
          currentLocation = cached.location;
          map.setView([currentLocation.lat, currentLocation.lon], 14);
          
          const mainMarker = L.marker([currentLocation.lat, currentLocation.lon], {
            icon: L.divIcon({
              className: 'custom-marker',
              html: `<div style="background-color: #ef4444; border: 3px solid white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 20px;">ğŸ“</div>`,
              iconSize: [40, 40],
              iconAnchor: [20, 40]
            })
          }).addTo(map);
          
          mainMarker.bindPopup(`<b>${query}</b><br>${currentLocation.name}`).openPopup();
          markers.push(mainMarker);
          
          displayPOIs(cached.pois);
          loading.classList.add('hidden');
          
          // Show cached weather if available
          if (cached.weather) {
            displayWeather(cached.weather);
          }
          return;
        }
        
        // Step 1: Geocode the location using Nominatim
        // Geocode via backend proxy
        const geocodeResponse = await fetch(`${API_BASE}/api/geocode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ q: query + ', Vietnam', limit: 1 })
        });
        const geocodeData = await geocodeResponse.json();
        
        logActivity('GEOCODE_SUCCESS', { query, resultCount: geocodeData.length });
        
        if (geocodeData.length === 0) {
          throw new Error('KhÃ´ng tÃ¬m tháº¥y Ä‘á»‹a Ä‘iá»ƒm. Vui lÃ²ng thá»­ láº¡i vá»›i tÃªn khÃ¡c.');
        }
        
        const location = geocodeData[0];
        currentLocation = {
          lat: parseFloat(location.lat),
          lon: parseFloat(location.lon),
          name: location.display_name
        };
        
        logActivity('LOCATION_FOUND', { 
          name: query, 
          coordinates: `${currentLocation.lat}, ${currentLocation.lon}` 
        });
        
        // Center map on location
        map.setView([currentLocation.lat, currentLocation.lon], 14);
        
        // Add main location marker
        const mainMarker = L.marker([currentLocation.lat, currentLocation.lon], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: #ef4444; border: 3px solid white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 20px;">ğŸ“</div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 40]
          })
        }).addTo(map);
        
        mainMarker.bindPopup(`<b>${query}</b><br>${currentLocation.name}`).openPopup();
        markers.push(mainMarker);
        
        // Step 2: Find points of interest via backend proxy (Overpass + fallback)
        await findPointsOfInterest(currentLocation.lat, currentLocation.lon);
        
        // Step 3: Fetch weather data via backend proxy
        await fetchWeather(currentLocation.lat, currentLocation.lon, query);
        
      } catch (error) {
        showError(error.message);
      } finally {
        loading.classList.add('hidden');
      }
    }
    
    // Fetch weather data from OpenWeatherMap API
    async function fetchWeather(lat, lon, locationName) {
      try {
        // Call local backend proxy for weather
        const response = await fetch(`${API_BASE}/api/weather`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon })
        });
        if (!response.ok) {
          console.warn('Weather API error:', response.status);
          return;
        }
        
        const data = await response.json();
        console.log('Weather data:', data);
        
        const weatherData = {
          temp: Math.round(data.main.temp),
          feels_like: Math.round(data.main.feels_like),
          humidity: data.main.humidity,
          pressure: data.main.pressure,
          description: data.weather[0].description,
          icon: data.weather[0].icon,
          wind_speed: data.wind.speed,
          clouds: data.clouds.all,
          location: locationName
        };
        
        displayWeather(weatherData);
        
        // Cache weather data
        if (locationInput.value.trim()) {
          const cacheKey = locationInput.value.trim().toLowerCase();
          const cached = searchCache.get(cacheKey) || {};
          cached.weather = weatherData;
          searchCache.set(cacheKey, cached);
        }
        
      } catch (error) {
        console.error('Weather fetch error:', error);
        // Don't show error to user, weather is optional feature
      }
    }
    
    // Display weather information
    function displayWeather(weather) {
      weatherSection.classList.remove('hidden');
      
      const iconUrl = `https://openweathermap.org/img/wn/${weather.icon}@2x.png`;
      
      weatherContent.innerHTML = `
        <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="text-5xl font-bold text-gray-800">${weather.temp}Â°C</div>
              <div class="text-sm text-gray-600 mt-1">Feels like ${weather.feels_like}Â°C</div>
            </div>
            <img src="${iconUrl}" alt="${weather.description}" class="w-20 h-20">
          </div>
          <div class="text-lg font-semibold text-gray-700 capitalize">${weather.description}</div>
        </div>
        
        <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">ğŸ’¨</span>
            <div>
              <div class="text-sm text-gray-600">Wind Speed</div>
              <div class="text-2xl font-bold text-gray-800">${weather.wind_speed} m/s</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-3xl">â˜ï¸</span>
            <div>
              <div class="text-sm text-gray-600">Cloudiness</div>
              <div class="text-2xl font-bold text-gray-800">${weather.clouds}%</div>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">ğŸ’§</span>
            <div>
              <div class="text-sm text-gray-600">Humidity</div>
              <div class="text-2xl font-bold text-gray-800">${weather.humidity}%</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-3xl">ğŸŒ¡ï¸</span>
            <div>
              <div class="text-sm text-gray-600">Pressure</div>
              <div class="text-2xl font-bold text-gray-800">${weather.pressure} hPa</div>
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 shadow-lg text-white">
          <div class="text-2xl font-bold mb-2">ğŸ“ ${weather.location}</div>
          <div class="text-sm opacity-90">Current weather conditions</div>
          <div class="mt-4 pt-4 border-t border-white border-opacity-30">
            <div class="text-xs opacity-75">Data from OpenWeatherMap</div>
          </div>
        </div>
      `;
    }
    
    // Find points of interest using Overpass API
    async function findPointsOfInterest(lat, lon) {
      try {
        logActivity('SEARCH_POI', { coordinates: `${lat}, ${lon}`, radius: 3000 });
        
        console.log('Searching for POIs via backend for:', lat, lon);
        const response = await fetch(`${API_BASE}/api/poi`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon, radius: 3000 })
        });

        if (!response.ok) {
          throw new Error('POI proxy error: ' + response.status);
        }

        const data = await response.json();

        if (data.fallback && data.pois) {
          console.log('Using fallback POIs from backend');
          logActivity('POI_FALLBACK_USED', { count: data.pois.length });
          displayPOIs(data.pois);
          return;
        }

        if (data.elements && data.elements.length > 0) {
          const pois = processPOIs(data.elements);
          logActivity('POI_FOUND', { count: pois.length });
          displayPOIs(pois);
          return;
        }

        // No results returned
        console.log('No POIs returned from backend');
        logActivity('POI_NOT_FOUND', {});
        showError('KhÃ´ng tÃ¬m tháº¥y Ä‘iá»ƒm thÃº vá»‹.');
        
      } catch (error) {
        console.error('POI search error:', error);
        logActivity('POI_ERROR', { error: error.message });
        showError('Lá»—i khi tÃ¬m kiáº¿m Ä‘iá»ƒm thÃº vá»‹: ' + (error.message || error));
      }
    }
    
    // Fallback handled server-side now; keep this function as a no-op placeholder
    async function findPOIsFallback(lat, lon) {
      console.log('Client fallback disabled; server-side fallback should handle missing POIs.');
    }
    
    // Helper function to get icon based on category
    function getIconForCategory(category) {
      const iconMap = {
        'restaurant': 'ğŸ½ï¸',
        'cafe': 'â˜•',
        'museum': 'ğŸ›ï¸',
        'park': 'ğŸŒ³',
        'hotel': 'ğŸ¨',
        'shop': 'ğŸ›ï¸',
        'tourism': 'ğŸ¯',
        'amenity': 'ğŸ“',
        'historic': 'ğŸ›ï¸',
        'leisure': 'ğŸ®'
      };
      return iconMap[category] || 'ğŸ“';
    }
    
    // Process POI data
    function processPOIs(elements) {
      const pois = [];
      const seenNames = new Set();
      
      // Filter elements to only those with names and valid tags
      const validElements = elements.filter(el => {
        const tags = el.tags || {};
        return tags.name && (tags.tourism || tags.amenity || tags.historic || tags.leisure || tags.shop || tags.building);
      });
      
      console.log('Valid named elements:', validElements.length);
      
      for (const element of validElements) {
        if (pois.length >= 5) break;
        
        let lat, lon;
        
        if (element.type === 'node') {
          lat = element.lat;
          lon = element.lon;
        } else if (element.type === 'way' && element.center) {
          lat = element.center.lat;
          lon = element.center.lon;
        } else if (element.type === 'way' && element.bounds) {
          // Calculate center from bounds
          lat = (element.bounds.minlat + element.bounds.maxlat) / 2;
          lon = (element.bounds.minlon + element.bounds.maxlon) / 2;
        } else {
          continue;
        }
        
        const tags = element.tags || {};
        const name = tags.name || tags['name:vi'] || tags['name:en'] || 'KhÃ´ng cÃ³ tÃªn';
        
        // Skip unnamed or duplicate entries
        if (name === 'KhÃ´ng cÃ³ tÃªn' || seenNames.has(name)) continue;
        seenNames.add(name);
        
        // Determine type
        let type = tags.tourism || tags.amenity || tags.historic || tags.leisure || tags.shop || tags.building || 'Äá»‹a Ä‘iá»ƒm';
        type = type.charAt(0).toUpperCase() + type.slice(1).replace(/_/g, ' ');
        
        // Get icon
        const icon = getIconForType(tags);
        
        pois.push({
          name,
          type,
          lat,
          lon,
          icon,
          description: tags.description || tags['addr:full'] || `${type} táº¡i ${currentLocation.name.split(',')[0]}`,
          address: tags['addr:street'] || tags['addr:city'] || ''
        });
      }
      
      console.log('Processed POIs:', pois.length);
      return pois;
    }
    
    // Get icon based on POI type
    function getIconForType(tags) {
      if (tags.tourism) {
        if (tags.tourism === 'hotel') return 'ğŸ¨';
        if (tags.tourism === 'museum') return 'ğŸ›ï¸';
        if (tags.tourism === 'attraction') return 'â­';
        if (tags.tourism === 'viewpoint') return 'ğŸ‘ï¸';
        if (tags.tourism === 'information') return 'â„¹ï¸';
        if (tags.tourism === 'gallery') return 'ğŸ–¼ï¸';
        return 'ğŸ¯';
      }
      if (tags.amenity) {
        if (tags.amenity === 'restaurant') return 'ğŸ½ï¸';
        if (tags.amenity === 'cafe') return 'â˜•';
        if (tags.amenity === 'museum') return 'ğŸ›ï¸';
        if (tags.amenity === 'theatre') return 'ğŸ­';
        if (tags.amenity === 'cinema') return 'ğŸ¬';
        if (tags.amenity === 'park') return 'ğŸŒ³';
        if (tags.amenity === 'attraction') return 'â­';
        return 'ğŸ“';
      }
      if (tags.historic) {
        if (tags.historic === 'monument') return 'ğŸ—¿';
        if (tags.historic === 'castle') return 'ğŸ°';
        if (tags.historic === 'memorial') return 'âš”ï¸';
        return 'ğŸ›ï¸';
      }
      if (tags.leisure) {
        if (tags.leisure === 'park') return 'ğŸŒ³';
        if (tags.leisure === 'garden') return 'ğŸŒº';
        if (tags.leisure === 'beach_resort') return 'ğŸ–ï¸';
        return 'ğŸ®';
      }
      return 'ğŸ“';
    }
    
    // Display POIs on map and list
    function displayPOIs(pois) {
      poiList.innerHTML = '';
      if (pois.length === 0) {
        showError('KhÃ´ng tÃ¬m tháº¥y Ä‘iá»ƒm thÃº vá»‹ nÃ o. Thá»­ Ä‘á»‹a Ä‘iá»ƒm khÃ¡c!');
        return;
      }
      
      poiSection.classList.remove('hidden');
      
      pois.forEach((poi, index) => {
        // Add marker to map
        const marker = L.marker([poi.lat, poi.lon], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div class="marker-icon">${index + 1}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 30]
          })
        }).addTo(map);
        
        marker.bindPopup(`
          <div class="p-2">
            <div class="text-lg font-bold">${poi.icon} ${poi.name}</div>
            <div class="text-sm text-gray-600">${poi.type}</div>
            <div class="text-xs text-gray-500 mt-1">${poi.description}</div>
          </div>
        `);
        
        markers.push(marker);
        
        // Add to list
        const card = document.createElement('div');
        card.className = 'poi-card bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 rounded-xl p-5 hover:shadow-xl';
        card.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="text-4xl flex-shrink-0">${poi.icon}</div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-gray-900 text-lg mb-1 truncate">${index + 1}. ${poi.name}</div>
              <div class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full mb-2">${poi.type}</div>
              <div class="text-sm text-gray-600 line-clamp-2">${poi.description}</div>
              ${poi.address ? `<div class="text-xs text-gray-500 mt-1">ğŸ“ ${poi.address}</div>` : ''}
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button class="view-map-btn flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all text-sm">
              ğŸ—ºï¸ Xem trÃªn báº£n Ä‘á»“
            </button>
            <button class="save-fav-btn px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white rounded-lg font-semibold transition-all text-sm shadow-lg">
              ğŸ’¾ LÆ°u
            </button>
          </div>
        `;
        
        // View on map handler
        card.querySelector('.view-map-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          map.setView([poi.lat, poi.lon], 16);
          marker.openPopup();
          document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        
        // Save to favorites handler
        card.querySelector('.save-fav-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          window.saveFavorite(poi);
        });
        
        poiList.appendChild(card);
      });
      
        // Fit map bounds to show all markers
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
      
      // Cache the results
      if (currentLocation && locationInput.value.trim()) {
        searchCache.set(locationInput.value.trim().toLowerCase(), {
          location: currentLocation,
          pois: pois,
          weather: searchCache.get(locationInput.value.trim().toLowerCase())?.weather
        });
      }
    }    // Clear all markers
    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }
    
    // Show error message
    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
    }
    
    // Hide error message
    function hideError() {
      errorMsg.classList.add('hidden');
    }
    
    // Event listeners
    searchBtn.addEventListener('click', searchLocation);
    
    locationInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchLocation();
      }
    });
    
    // Quick search buttons
    document.querySelectorAll('.quick-search').forEach(btn => {
      btn.addEventListener('click', () => {
        locationInput.value = btn.dataset.location;
        searchLocation();
      });
    });
    
    // Debug panel toggle
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const panel = document.getElementById('debugPanel');
        panel.classList.toggle('hidden');
      }
    });
    
    // Override console.log to show in debug panel
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
        debugContent.innerHTML += `<div class="border-t border-gray-700 pt-1 mt-1">${msg}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
      }
    };

    // --- Translation feature (calls backend) ---
    const TRANSLATE_API = `${FLASK_BASE}/translate`; // backend now runs on 5001
    const translateBtn = document.getElementById('translateBtn');
    const clearTranslateBtn = document.getElementById('clearTranslateBtn');
    const translateInput = document.getElementById('translateInput');
    const translateResult = document.getElementById('translateResult');
    const translatedText = document.getElementById('translatedText');
    const copyTranslateBtn = document.getElementById('copyTranslateBtn');
    const openInNewBtn = document.getElementById('openInNewBtn');

    async function doTranslate() {
      const text = (translateInput.value || '').trim();
      if (!text) return;
      
      logActivity('TRANSLATE', { text, length: text.length });
      
      translateBtn.disabled = true;
      translateBtn.textContent = 'Äang dá»‹ch...';
      translateResult.classList.add('hidden');
      try {
        const resp = await fetch(TRANSLATE_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Lá»—i dá»‹ch');
        translatedText.textContent = data.translated;
        translateResult.classList.remove('hidden');
        logActivity('TRANSLATE_SUCCESS', { translated: data.translated });
      } catch (err) {
        logActivity('TRANSLATE_ERROR', { error: err.message });
        alert('Lá»—i dá»‹ch: ' + err.message);
      } finally {
        translateBtn.disabled = false;
        translateBtn.textContent = 'Dá»‹ch';
      }
    }

    translateBtn.addEventListener('click', doTranslate);
    translateInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) doTranslate(); });
    clearTranslateBtn.addEventListener('click', () => {
      translateInput.value = '';
      translatedText.textContent = '';
      translateResult.classList.add('hidden');
      translateInput.focus();
    });
    copyTranslateBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(translatedText.textContent || ''); alert('ÄÃ£ sao chÃ©p'); }
      catch { alert('KhÃ´ng thá»ƒ sao chÃ©p'); }
    });
    openInNewBtn.addEventListener('click', () => {
      const url = 'https://translate.google.com/?sl=en&tl=vi&text=' + encodeURIComponent(translateInput.value || '') + '&op=translate';
      window.open(url, '_blank');
    });
    
    // Example searches (optional demo)
    console.log('VÃ­ dá»¥ Ä‘á»‹a Ä‘iá»ƒm báº¡n cÃ³ thá»ƒ tÃ¬m:');
    console.log('- HÃ  Ná»™i');
    console.log('- Há»™i An');
    console.log('- ÄÃ  Náºµng');
    console.log('- Nha Trang');
    console.log('- Phá»‘ cá»• HÃ  Ná»™i');

    // Quick Translator removed - using main translator instead

    // ============================================
    // FIREBASE AUTHENTICATION & FIRESTORE SETUP
    // ============================================
  </script>
  
  <!-- Firebase SDKs (v10+ modular via CDN) -->
  <script type="module">
    // Firebase configuration (from main.html)
    const firebaseConfig = {
      apiKey: "AIzaSyAoHX6TfI-VltWYDu74Xxow2o_hALxG74U",
      authDomain: "ct-week5-24125093.firebaseapp.com",
      projectId: "ct-week5-24125093",
      storageBucket: "ct-week5-24125093.firebasestorage.app",
      messagingSenderId: "865614325692",
      appId: "1:865614325692:web:849713e289f0b2c07fedb9"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI elements for auth
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const userChip = document.getElementById("userChip");
    const avatar = document.getElementById("avatar");
    const displayName = document.getElementById("displayName");
    const authHint = document.getElementById("authHint");
    const favoritesSection = document.getElementById("favoritesSection");
    const favoritesList = document.getElementById("favoritesList");
    const noFavorites = document.getElementById("noFavorites");

    const provider = new GoogleAuthProvider();

    // UI elements for login screen
    const loginScreen = document.getElementById("loginScreen");
    const btnLoginScreen = document.getElementById("btnLoginScreen");
    const appContent = document.getElementById("appContent");
    
    // Auth UI handlers
    btnSignIn.classList.remove("hidden");
    
    // Login screen button handler
    btnLoginScreen.addEventListener("click", async () => {
      btnLoginScreen.disabled = true;
      btnLoginScreen.innerHTML = '<span class="animate-spin">â³</span> <span>Äang Ä‘Äƒng nháº­p...</span>';
      try { 
        await signInWithPopup(auth, provider);
        console.log('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!');
      } 
      catch (e) { 
        console.error('Login error:', e);
        alert('Lá»—i Ä‘Äƒng nháº­p: ' + e.message);
        btnLoginScreen.disabled = false;
        btnLoginScreen.innerHTML = '<span>ğŸ”</span> <span>ÄÄƒng nháº­p vá»›i Google</span>';
      }
    });
    
    // Header login button handler
    btnSignIn.addEventListener("click", async () => {
      try { 
        await signInWithPopup(auth, provider);
        console.log('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!');
      } 
      catch (e) { 
        console.error('Login error:', e);
        alert('Lá»—i Ä‘Äƒng nháº­p: ' + e.message); 
      }
    });
    
    btnSignOut.addEventListener("click", () => {
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t?')) {
        signOut(auth);
      }
    });

    let unsubFavorites = null;

    // Auth state observer
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User signed in
        console.log('ğŸ‘¤ User logged in:', user.displayName || user.email);
        
        // Hide login screen, show app content
        loginScreen.classList.add("hidden");
        appContent.classList.remove("blurred");
        
        btnSignIn.classList.add("hidden");
        userChip.classList.remove("hidden");
        userChip.classList.add("flex");
        avatar.src = user.photoURL || "https://ui-avatars.com/api/?name="+encodeURIComponent(user.displayName||"User");
        displayName.textContent = user.displayName || user.email;

        authHint.innerHTML = 'âœ… <strong>ÄÃ£ Ä‘Äƒng nháº­p!</strong> Báº¡n cÃ³ thá»ƒ lÆ°u Ä‘á»‹a Ä‘iá»ƒm yÃªu thÃ­ch.';
        authHint.className = 'mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-800 text-center';

        // Show favorites section
        favoritesSection.classList.remove('hidden');

        // Subscribe to user's favorites
        if (unsubFavorites) unsubFavorites();
        const q = query(
          collection(db, "favorites"),
          where("uid", "==", user.uid),
          orderBy("createdAt", "desc")
        );
        
        unsubFavorites = onSnapshot(q, (snap) => {
          favoritesList.innerHTML = "";
          
          if (snap.empty) {
            noFavorites.classList.remove('hidden');
            return;
          }
          
          noFavorites.classList.add('hidden');
          
          snap.forEach((docSnap) => {
            const data = docSnap.data();
            const card = document.createElement('div');
            card.className = 'poi-card bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl p-5 shadow-lg';
            card.innerHTML = `
              <div class="flex items-start gap-3 mb-3">
                <span class="text-3xl">${data.icon || 'ğŸ“'}</span>
                <div class="flex-1">
                  <h3 class="font-bold text-lg text-gray-900">${data.name}</h3>
                  <p class="text-sm text-gray-600 mt-1">${data.type}</p>
                  ${data.address ? `<p class="text-xs text-gray-500 mt-1">ğŸ“ ${data.address}</p>` : ''}
                </div>
                <button class="remove-fav-btn text-red-500 hover:text-red-700 text-xl font-bold" data-id="${docSnap.id}" title="XÃ³a">
                  âŒ
                </button>
              </div>
              <div class="text-xs text-gray-400 mt-2">
                ÄÃ£ lÆ°u: ${data.createdAt?.toDate?.().toLocaleDateString('vi-VN') || 'Vá»«a xong'}
              </div>
              <button class="view-on-map-btn mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all" 
                      data-lat="${data.lat}" data-lon="${data.lon}" data-name="${data.name}">
                ğŸ—ºï¸ Xem trÃªn báº£n Ä‘á»“
              </button>
            `;
            
            // Remove favorite handler
            card.querySelector('.remove-fav-btn').addEventListener('click', async (e) => {
              e.stopPropagation();
              if (confirm('XÃ³a Ä‘á»‹a Ä‘iá»ƒm nÃ y khá»i yÃªu thÃ­ch?')) {
                try {
                  await deleteDoc(doc(db, "favorites", docSnap.id));
                  console.log('ğŸ—‘ï¸ ÄÃ£ xÃ³a yÃªu thÃ­ch');
                } catch (err) {
                  console.error('Delete error:', err);
                  alert('Lá»—i khi xÃ³a: ' + err.message);
                }
              }
            });
            
            // View on map handler
            card.querySelector('.view-on-map-btn').addEventListener('click', () => {
              const lat = parseFloat(card.querySelector('.view-on-map-btn').dataset.lat);
              const lon = parseFloat(card.querySelector('.view-on-map-btn').dataset.lon);
              const name = card.querySelector('.view-on-map-btn').dataset.name;
              
              map.setView([lat, lon], 16);
              
              // Find and open the marker popup if it exists
              markers.forEach(marker => {
                const markerLatLng = marker.getLatLng();
                if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lon) < 0.0001) {
                  marker.openPopup();
                }
              });
              
              // Smooth scroll to map
              document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            
            favoritesList.appendChild(card);
          });
        });

      } else {
        // User signed out
        console.log('ğŸ‘¤ User logged out');
        
        // Show login screen, blur app content
        loginScreen.classList.remove("hidden");
        appContent.classList.add("blurred");
        
        btnSignIn.classList.remove("hidden");
        userChip.classList.add("hidden");
        userChip.classList.remove("flex");
        
        authHint.innerHTML = 'ğŸ’¡ <strong>ÄÄƒng nháº­p</strong> Ä‘á»ƒ lÆ°u cÃ¡c Ä‘á»‹a Ä‘iá»ƒm yÃªu thÃ­ch cá»§a báº¡n!';
        authHint.className = 'mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 text-center';
        
        favoritesSection.classList.add('hidden');
        
        if (unsubFavorites) { 
          unsubFavorites(); 
          unsubFavorites = null; 
        }
      }
    });

    // Function to save a favorite place (called from POI cards)
    window.saveFavorite = async function(poi) {
      const user = auth.currentUser;
      if (!user) {
        alert('âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ lÆ°u Ä‘á»‹a Ä‘iá»ƒm yÃªu thÃ­ch!');
        btnSignIn.click();
        return;
      }
      
      try {
        await addDoc(collection(db, "favorites"), {
          uid: user.uid,
          name: poi.name,
          type: poi.type,
          lat: poi.lat,
          lon: poi.lon,
          icon: poi.icon,
          address: poi.address || '',
          createdAt: serverTimestamp()
        });
        
        console.log('âœ… ÄÃ£ lÆ°u yÃªu thÃ­ch:', poi.name);
        
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-2xl z-50 animate-bounce';
        notification.innerHTML = 'â­ ÄÃ£ lÆ°u vÃ o yÃªu thÃ­ch!';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 2000);
        
      } catch (error) {
        console.error('Save favorite error:', error);
        alert('Lá»—i khi lÆ°u: ' + error.message);
      }
    };
  </script>
</body>
</html>
